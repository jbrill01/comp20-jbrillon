<!DOCTYPE HTML>
<html>
<head>
<title>Assignment Two</title>
<link rel="stylesheet" href="styles.css" type="text/css" />
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>

	<script>
	var mylat = 0;
	var mylong = 0;
	var data;
	var students;
	var characters;
	var mylocation = new google.maps.LatLng(mylat, mylong);
	var map;
	var numbers = [];
	var request = new XMLHttpRequest();
    var mapSetUp = {
        center: mylocation,
    	zoom: 15
    };
    var marker;
    var infowindow = new google.maps.InfoWindow();
	function initialize() {
        map = new google.maps.Map(document.getElementById('mapCanvas'),
            mapSetUp);
        getLocation();
    }

	function getLocation() {
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(updateStuff);
		} else {
			alert("Unfortunately, geolocation does not work on your current web browser");
		}
	}

	function updateStuff(position) {
		mylat = position.coords.latitude;
		mylong = position.coords.longitude;
		renderMap();
	}

	function renderMap() {
		mylocation = new google.maps.LatLng(mylat, mylong);
				
		map.panTo(mylocation);
	
		marker = new google.maps.Marker({
			position: mylocation,
			title: "Dean Thomas",
			icon: "dean_thomas.png"
		});
		marker.setMap(map);
					
		google.maps.event.addListener(marker, 'click', function() {
			infowindow.setContent(marker.title + "<br />" + "latitude: " + mylat + "<br />" + "longitude: " + mylong + "<br />" + "distances: " + numbers);
			infowindow.open(map, marker);
		});
		request.open("POST", "http://chickenofthesea.herokuapp.com/sendLocation", true);
		request.onreadystatechange=function() {
			if (request.readyState==4 && request.status==200) {
			data = JSON.parse(request.responseText);
			characters = data.characters;
			students = data.students;
			for (var i = 0; i < students.length; i++) {
				var marker = new google.maps.Marker({
					map: map,
					position: new google.maps.LatLng(students[i].lat, students[i].lng),
					title: students[i].login
				});
				google.maps.event.addListener(marker, 'click', function() {
					infowindow.close();
					infowindow.setContent(this.title + "<br />" + "position: " + this.position);
					infowindow.open(map, this);
				});
			}
			for (var i = 0; i < characters.length; i++) {
				var pic = "images/" + characters[i].name + ".png";
				var marker = new google.maps.Marker({
					map: map,
					position: new google.maps.LatLng(characters[i].loc.latitude, characters[i].loc.longitude),
					title: characters[i].name,
					icon: pic
			});
				google.maps.event.addListener(marker, 'click', function() {
					infowindow.close();
					infowindow.setContent(this.title + "<br />" + "latitude: " + this.position);
					infowindow.open(map, this);
				});
				var polylinecoordinates = [mylocation, new google.maps.LatLng(characters[i].loc.latitude, characters[i].loc.longitude)];
				var polyline = new google.maps.Polyline({
					path: polylinecoordinates,
					geodesic: true,
					strokeColor: '#6699CC',
					strokeOpacity: 1.0,
					strokeWeight: 2
				});
				polyline.setMap(map);
				var R = 3959;
				var lat1 = characters[i].loc.latitude;
				var dLat = (characters[i].loc.latitude - mylat) * (Math.PI/180);
				var dLon = (characters[i].loc.longitude - mylong) * (Math.PI/180);
				var a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
                    Math.cos(lat1 * (Math.PI/180)) * Math.cos(mylat * (Math.PI/180)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);  
    			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
   		 		var d = R * c;
   		 		numbers[i] = d;
   		 		numbers = numbers.sort(function(a,b) { return a-b;});
		}
			}
		}
		request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		request.send("login=DeanThomas&lat="+mylat+"&lng="+mylong);
	}

	google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>
<body>
	<div id="mapCanvas"></div>
</body>
</html>